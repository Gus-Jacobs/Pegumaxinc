{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Live Bot Logs</title>
    <!-- <link rel="stylesheet" href="{% static 'css/your_styles.css' %}"> -->
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background-color: #f8f9fa; }
        .container { max-width: 1000px; margin: auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h2 { color: #333; }
        #live-logs-container {
            background-color: #282c34; /* Dark background */
            color: #abb2bf; /* Light grey text */
            font-family: 'Courier New', Courier, monospace;
            padding: 15px;
            border-radius: 5px;
            height: 600px;
            overflow-y: auto;
            font-size: 0.9em;
            white-space: pre-wrap; /* Preserve whitespace and wrap lines */
            border: 1px solid #444;
        }
        .log-entry {
            margin-bottom: 5px;
            border-bottom: 1px solid #3e4451;
            padding-bottom: 5px;
        }
        .log-entry:last-child { border-bottom: none; }
        .log-entry .timestamp { color: #61afef; } /* Blue for timestamp */
        .log-entry .level-INFO { color: #98c379; } /* Green for INFO */
        .log-entry .level-WARNING { color: #e5c07b; } /* Yellow for WARNING */
        .log-entry .level-ERROR, .log-entry .level-CRITICAL { color: #e06c75; font-weight: bold; } /* Red for ERROR/CRITICAL */
        .log-entry .platform { color: #c678dd; } /* Purple for platform */
        .log-entry .source { color: #56b6c2; } /* Cyan for source */
    </style>
</head>
<body>
<div class="container">
    <h2>Live Bot Log Stream</h2>
    <p>Displaying recent unacknowledged logs. Updates periodically.</p>
    <div id="live-logs-container">
        <p>Loading logs...</p>
    </div>
</div>

<script>
    const liveLogsApiUrl = "{% url 'bot_monitor:get_bot_logs' %}";
    const logsContainer = document.getElementById('live-logs-container');

    async function fetchLiveLogs() {
        try {
            const response = await fetch(`${liveLogsApiUrl}?type=all_unacknowledged&limit=100`); 
            if (!response.ok) {
                logsContainer.innerHTML += `<p class="log-entry level-ERROR">Error fetching logs: ${response.status}</p>`;
                return;
            }
            const logs = await response.json();

            if (logs.length > 0 || logsContainer.textContent.includes("Loading logs...")) {
                 logsContainer.innerHTML = ''; 
            } else if (logs.length === 0 && !logsContainer.textContent.includes("No new logs")) {
                 logsContainer.innerHTML = '<p>No new logs to display.</p>';
            }

            logs.forEach(log => {
                const logElement = document.createElement('div');
                logElement.classList.add('log-entry');
                const levelClass = `level-${(log.log_level || '').toUpperCase()}`;
                logElement.innerHTML = `
                    <span class="timestamp">[${new Date(log.timestamp).toLocaleString()}]</span>
                    <span class="${levelClass}">${escapeHtml(log.log_level)}</span>
                    ${log.platform ? ` - <span class="platform">${escapeHtml(log.platform)}</span>` : ''}
                    ${log.source ? ` (<span class="source">${escapeHtml(log.source)}</span>)` : ''}
                    : ${escapeHtml(log.message)}
                `;
                logsContainer.appendChild(logElement);
            });
            if (logs.length > 0) logsContainer.scrollTop = logsContainer.scrollHeight;

        } catch (error) {
            console.error("Error fetching live logs:", error);
            logsContainer.innerHTML += `<p class="log-entry level-ERROR">Error fetching logs: ${error}</p>`;
        }
    }
    
    function escapeHtml(unsafe) {
        if (unsafe === null || typeof unsafe === 'undefined') return '';
        return String(unsafe)
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }

    fetchLiveLogs();
    setInterval(fetchLiveLogs, 7000);
</script>
</body>
</html>
