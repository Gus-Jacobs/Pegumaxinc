{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Bot Dashboard</title>
    <!-- Link to your existing CSS or use Bootstrap if available -->
    <!-- <link rel="stylesheet" href="{% static 'css/your_styles.css' %}"> -->
    <style>
        body { font-family: sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; color: #333; }
        .container { max-width: 1200px; margin: auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h2, h4 { color: #333; }
        .card { border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px; }
        .card-body { padding: 15px; }
        .card-title { margin-top: 0; margin-bottom: 10px; font-size: 1.2em; }
        .row { display: flex; flex-wrap: wrap; margin-right: -15px; margin-left: -15px; }
        .col-md-4 { position: relative; width: 100%; padding-right: 15px; padding-left: 15px; flex: 0 0 33.333333%; max-width: 33.333333%; }
        .btn { display: inline-block; font-weight: 400; color: #212529; text-align: center; vertical-align: middle; cursor: pointer; background-color: transparent; border: 1px solid transparent; padding: .375rem .75rem; font-size: 1rem; line-height: 1.5; border-radius: .25rem; transition: color .15s ease-in-out,background-color .15s ease-in-out,border-color .15s ease-in-out,box-shadow .15s ease-in-out; }
        .btn-sm { padding: .25rem .5rem; font-size: .875rem; line-height: 1.5; border-radius: .2rem; }
        .btn-danger { color: #fff; background-color: #dc3545; border-color: #dc3545; }
        .btn-primary { color: #fff; background-color: #007bff; border-color: #007bff; }
        .btn-warning { color: #212529; background-color: #ffc107; border-color: #ffc107; }
        .btn-secondary { color: #fff; background-color: #6c757d; border-color: #6c757d; }
        .btn-info { color: #fff; background-color: #17a2b8; border-color: #17a2b8; }
        .btn-success { color: #fff; background-color: #28a745; border-color: #28a745; }
        .btn-group .btn { margin-right: 5px; }
        .badge { display: inline-block; padding: .25em .4em; font-size: 75%; font-weight: 700; line-height: 1; text-align: center; white-space: nowrap; vertical-align: baseline; border-radius: .25rem; }
        .bg-secondary { background-color: #6c757d !important; }
        .bg-success { background-color: #28a745 !important; }
        .bg-danger { background-color: #dc3545 !important; }
        .bg-info { background-color: #17a2b8 !important; }
        .bg-warning { background-color: #ffc107 !important; color: #212529 !important; }
        .table-responsive { display: block; width: 100%; overflow-x: auto; }
        .table { width: 100%; margin-bottom: 1rem; color: #212529; border-collapse: collapse; }
        .table th, .table td { padding: .75rem; vertical-align: top; border-top: 1px solid #dee2e6; }
        .table thead th { vertical-align: bottom; border-bottom: 2px solid #dee2e6; }
        .table-striped tbody tr:nth-of-type(odd) { background-color: rgba(0,0,0,.05); }
        .mb-3 { margin-bottom: 1rem !important; }
    </style>
</head>
<body>
<div class="container">
    <h2>Bot Administration Dashboard</h2>
    <hr>

    <div class="row mb-3">
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Bot Status</h5>
                    <p id="bot-active-status">Status: <span class="badge bg-secondary">Unknown</span></p>
                    <p id="bot-last-heartbeat">Last Heartbeat: N/A</p>
                    <p id="bot-current-message">Message: N/A</p>
                    <p id="bot-current-command">Command: N/A</p>
                    <button id="stop-bot-btn" class="btn btn-danger btn-sm">Request Bot Stop</button>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Log Activity</h5>
                    <p>Unacknowledged Logs: <span id="unread-logs-count" class="badge bg-info">0</span></p>
                    <p>Critical Errors (Unack.): <span id="critical-errors-count" class="badge bg-danger">0</span></p>
                </div>
            </div>
        </div>
    </div>

    <h4>Manage Logs</h4>
    <div class="btn-group mb-3" role="group">
        <button type="button" class="btn btn-primary" onclick="fetchLogs('recent_unacknowledged')">Recent Unacknowledged</button>
        <button type="button" class="btn btn-warning" onclick="fetchLogs('critical_unacknowledged')">Critical Unacknowledged</button>
        <button type="button" class="btn btn-secondary" onclick="fetchLogs('all_unacknowledged')">All Unacknowledged</button>
        <button type="button" class="btn btn-info" onclick="fetchLogs('all')">All Logs (Recent 50)</button>
    </div>
    
    <button id="acknowledge-selected-btn" class="btn btn-success mb-3" style="display:none;" onclick="acknowledgeSelectedLogs()">Acknowledge Selected</button>

    <div id="logs-display-area" class="table-responsive">
        <table class="table table-striped table-sm">
            <thead>
                <tr>
                    <th><input type="checkbox" id="select-all-logs" onclick="toggleSelectAllLogs(this.checked)"></th>
                    <th>Timestamp</th>
                    <th>Level</th>
                    <th>Platform</th>
                    <th>Source</th>
                    <th>Message</th>
                    <th>Ack?</th>
                </tr>
            </thead>
            <tbody id="logs-table-body">
                <tr><td colspan="7">Select a log type to view.</td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    const dashboardApiUrl = "{% url 'bot_monitor:dashboard_data' %}";
    const logsApiUrl = "{% url 'bot_monitor:get_bot_logs' %}";
    const acknowledgeApiUrl = "{% url 'bot_monitor:acknowledge_logs' %}";
    const commandApiUrl = "{% url 'bot_monitor:bot_command' %}";

    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');

    async function fetchDashboardData() {
        try {
            const response = await fetch(dashboardApiUrl);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const data = await response.json();

            document.getElementById('bot-active-status').innerHTML = `Status: <span class="badge ${data.is_bot_active ? 'bg-success' : 'bg-danger'}">${data.is_bot_active ? 'Active' : 'Inactive'}</span>`;
            document.getElementById('bot-last-heartbeat').textContent = `Last Heartbeat: ${new Date(data.last_heartbeat).toLocaleString()}`;
            document.getElementById('bot-current-message').textContent = `Message: ${data.bot_status_message}`;
            document.getElementById('bot-current-command').textContent = `Command: ${data.bot_command}`;
            document.getElementById('unread-logs-count').textContent = data.unread_logs_count;
            document.getElementById('critical-errors-count').textContent = data.critical_errors_count;
        } catch (error) {
            console.error("Error fetching dashboard data:", error);
            document.getElementById('bot-active-status').innerHTML = `Status: <span class="badge bg-warning">Error Fetching</span>`;
        }
    }

    async function fetchLogs(logType = 'recent_unacknowledged') {
        const logsTableBody = document.getElementById('logs-table-body');
        logsTableBody.innerHTML = '<tr><td colspan="7">Loading logs...</td></tr>';
        document.getElementById('acknowledge-selected-btn').style.display = 'none';
        document.getElementById('select-all-logs').checked = false;

        try {
            const response = await fetch(`${logsApiUrl}?type=${logType}&limit=50`);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const logs = await response.json();

            if (logs.length === 0) {
                logsTableBody.innerHTML = '<tr><td colspan="7">No logs found for this type.</td></tr>';
                return;
            }

            let rowsHtml = '';
            logs.forEach(log => {
                rowsHtml += `
                    <tr>
                        <td><input type="checkbox" class="log-checkbox" value="${log.id}" ${log.is_acknowledged ? 'disabled' : ''}></td>
                        <td>${new Date(log.timestamp).toLocaleString()}</td>
                        <td><span class="badge bg-${getLogLevelClass(log.log_level)}">${log.log_level}</span></td>
                        <td>${escapeHtml(log.platform) || 'N/A'}</td>
                        <td>${escapeHtml(log.source) || 'N/A'}</td>
                        <td>${escapeHtml(log.message.substring(0, 150))}${log.message.length > 150 ? '...' : ''}</td>
                        <td>${log.is_acknowledged ? 'Yes' : 'No'}</td>
                    </tr>
                `;
            });
            logsTableBody.innerHTML = rowsHtml;
            if (logs.some(log => !log.is_acknowledged)) {
                 document.getElementById('acknowledge-selected-btn').style.display = 'inline-block';
            }
        } catch (error) {
            console.error("Error fetching logs:", error);
            logsTableBody.innerHTML = '<tr><td colspan="7">Error loading logs.</td></tr>';
        }
    }
    
    function getLogLevelClass(level) {
        level = (level || '').toUpperCase();
        if (level === 'ERROR' || level === 'CRITICAL') return 'danger';
        if (level === 'WARNING') return 'warning';
        if (level === 'INFO') return 'info';
        return 'secondary';
    }

    function escapeHtml(unsafe) {
        if (unsafe === null || typeof unsafe === 'undefined') return '';
        return String(unsafe)
             .replace(/&/g, "&amp;")
             .replace(/</g, "&lt;")
             .replace(/>/g, "&gt;")
             .replace(/"/g, "&quot;")
             .replace(/'/g, "&#039;");
    }

    function toggleSelectAllLogs(checked) {
        document.querySelectorAll('.log-checkbox:not(:disabled)').forEach(checkbox => {
            checkbox.checked = checked;
        });
    }

    async function acknowledgeSelectedLogs() {
        const selectedLogIds = Array.from(document.querySelectorAll('.log-checkbox:checked'))
                                   .map(cb => parseInt(cb.value));
        if (selectedLogIds.length === 0) {
            alert("Please select logs to acknowledge.");
            return;
        }

        try {
            const response = await fetch(acknowledgeApiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify({ log_ids: selectedLogIds })
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            alert(result.message);
            fetchDashboardData(); 
            const currentLogType = document.querySelector('.btn-group .btn.active') ? document.querySelector('.btn-group .btn.active').getAttribute('data-log-type') || 'recent_unacknowledged' : 'recent_unacknowledged';
            fetchLogs(currentLogType);
        } catch (error) {
            console.error("Error acknowledging logs:", error);
            alert("Failed to acknowledge logs.");
        }
    }

    async function sendBotStopCommand() {
        if (!confirm("Are you sure you want to request the bot to stop?")) return;
        try {
            const response = await fetch(commandApiUrl, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
                body: JSON.stringify({ command: "STOP_REQUESTED" })
            });
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            const result = await response.json();
            alert(result.message);
            fetchDashboardData();
        } catch (error) {
            console.error("Error sending stop command:", error);
            alert("Failed to send stop command.");
        }
    }

    document.getElementById('stop-bot-btn').addEventListener('click', sendBotStopCommand);
    document.querySelectorAll('.btn-group .btn').forEach(button => {
        button.addEventListener('click', (e) => {
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
            e.target.classList.add('active');
            // Store log type in a data attribute if needed, or pass directly
            // fetchLogs(e.target.getAttribute('data-log-type')); 
        });
    });

    fetchDashboardData();
    fetchLogs();
    setInterval(fetchDashboardData, 30000);
</script>
</body>
</html>
